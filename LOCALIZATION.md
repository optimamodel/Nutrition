# Localization

Translation of Optima Nutrition into different languages/locales takes place in three places

- In the backend Python code
- In the databooks  
- In the web interface

## Localization (Python)

Backend localization is needed for any strings that are hardcoded into the Python application. For example, error messages are generated by the backend code and need to be localized. Similarly, the databook may contain certain keywords (e.g. 'Population') that need to be localized when reading in the databook. Localization in the backend uses standard Python functionality provided by `gettext`, and the locales are managed using `babel`.

Strings that require translation are passed through a 'translation function' which is assigned to `_` by convention. `babel` scans through the package searching for strings occurring inside `_` and then uses them to update the catalog files.

To update strings after adding new strings in code, run the following commands. Theses create `nutrition/locale/nutrition.pot`

    python setup.py extract_messages
    python setup.py update_catalog

To set up a new locale e.g. `en`. This creates `nutrition/locale/en/LC_MESSAGES/nutrition.po`

    python setup.py init_catalog -l en

To update translations (after modifying translated text)

    python setup.py compile_catalog

Normal workflow would be

1. Add `_ = utils.get_translator(locale)` in the appropriate scope. `utils.locale` contains the fallback/default locale
2. Modify strings to be passed through `_` for translation
3. Run the extract messages and update catalog steps above
4. Edit the `.po` files to populate the translations
5. Compile the catalog
6. Commit all files

## Localization (Excel)

Some strings also appear in the databook, such as program names or population names. These need to be localized in the databook templates as well as in the code, because the databooks are not generated programatically. The workflow for generating translated databooks is to start with a complete English template. Then, an Excel file containing translations is created.

The reference files are in `inputs/en`. Remaining files are automatically generated using `translate.py`. This script does the following for each file in `en`:

- Copy file to locale folder e.g. `fr`
- Finds and replaces all strings matched in `translations.xlsx`

Therefore, `translate.py` generated translated versions of the `en` files.

To preserve the files as precisely as possible, the translation is carried out by remote-controlling Microsoft Excel. Therefore, **this script can only be run on a Windows machine with Microsoft Excel installed**.

CAUTION - translations should be ordered from longest to shortest to avoid issues related to substrings (e.g. if part of a string is substituted, resulting in a longer string failing to match later on)

For strings that appear in both the databook and in the code, the translations in the `.po` files are automatically populated if the message ID matches the string in the source locale column. Consider the example of `12-24 months` which appears in both the databook and in the code. The workflow to translate this string is

1. Wrap the string in a translation function in the code i.e. `_('12-24 months)`
2. Extract messages and update the catalog so that the message id `12-24 months` appears in the `.po` files
3. Add the translation for `12-24 months` to `translations.xlsx`
4. Run `translate.py` which will do two things - it will generate translated databooks including the new string, and it will also overwrite the translation for `12-24 months` in the `.po` files
5. Compile the catalog and commit all files

## Localization (Vue)

To add a translation

1. Make a string in the `.vue` file using the `$t` function
2. Use `npm run translate` to scan the `.vue` files and update the catalogs
3. Fill in the translations in the catalog files

Translations are in `src/locales` and also need to appear in `src/js/utils.js` in the list of available locales (this is how the locale will end up in the locale switcher). To add a locale, add an entry to `utils.js`, create a blank translation in `src/locales` and then run `npm run translate`

To access the current locale, use `import i18n from '../i18n'` in the scripts section. `i18n.locale` is then accessible as the current locale in callbacks. Within the template, use `$i18n.locale` - see `LocaleSwitcher.vue` for an example.
